name: acmeair-closeConnection
ergonomics:
  privateHttpPools: true
http:
  host: http://acme.dalperf.us-south.containers.appdomain.cloud
  sharedConnections: 30
phases:
- flightRampUp:
    rampPerSec:
      duration: 50s
      initialUsersPerSec: 1
      targetUsersPerSec: 10
      maxSessions: 50
      scenario: &queryFlight
      - queryFlight:
        - randomItem:
            file: AirportsFrom.txt
            toVar: fromCode
        - randomItem:
            file: AirportsTo.txt
            toVar: toCode
        - flightDates:
            fromDate: departureDate
            returnDate: returnDate
        - httpRequest:
            POST:
              value: /flight/queryflights
            body:
              form:
              - name: fromAirport
                pattern: ${fromCode}
              - name: toAirport
                pattern: ${toCode}
              - name: fromDate
                pattern: ${departureDate}
              - name: returnDate
                pattern: ${returnDate}
              - name: oneWay
                value: true
            handler:
              body:
                closeConnection: {}
- FLIGHT_SEARCH:
    constantPerSec:
      duration: 50s
      usersPerSec: 10
      startAfter: flightRampUp
      scenario: *queryFlight


- profileRampUp:
    rampPerSec:
      duration: 50s
      initialUsersPerSec: 1
      targetUsersPerSec: 10
      maxSessions: 50
      scenario: &updateProfile
        initialSequences:
        - login:
          - randomInt:
              min: 0
              #9999 for 10000 users
              max: 10
              toVar: userId
          - httpRequest:
              POST:
                value: /auth/login
              body:
                form:
                - name: login
                  pattern: uid${userId}@email.com
                - name: password
                  value: password
              handler:
                header:
                  - cookie:
                      name: jwt_token
                      toVar: jwtToken
          - nextSequence: viewProfile
        sequences:
        - viewProfile:
          - httpRequest:
              headers:
                Authorization:
                  pattern: Bearer ${jwtToken}
              GET:
                pattern: /customer/byid/uid${userId}@email.com
              handler:
                body:
                  closeConnection: {}


- PROFILE_UPDATE:
    constantPerSec:
      duration: 50s
      usersPerSec: 10
      startAfter: profileRampUp
      scenario: *updateProfile